#!/usr/bin/ksh
# IBM_PROLOG_BEGIN_TAG 
# This is an automatically generated prolog. 
#  
# bos610 src/bos/usr/lib/security/aixpert/scripts/virusdetsw.sh 1.3 
#  
# Licensed Materials - Property of IBM 
#  
# Restricted Materials of IBM 
#  
# COPYRIGHT International Business Machines Corp. 2007 
# All Rights Reserved 
#  
# US Government Users Restricted Rights - Use, duplication or 
# disclosure restricted by GSA ADP Schedule Contract with IBM Corp. 
#  
# @(#)94	1.3  src/bos/usr/lib/security/aixpert/scripts/virusdetsw.sh, aixpert, bos610 2/21/07 22:44:41
# IBM_PROLOG_END_TAG 
#       COMPONENT_NAME          : (AIXPERT) virusdetsw.sh
#       FUNCTIONS               : None
#       ORIGINS                 : 27
#
#       Command Line Arguments  : This script helps in detecting malicious
#				  software on the machine as per the
#				  SOX guidelines.
#
#       OUTPUT                  : None
#
#       Description             : It runs trustchk comamnd on all binaries
#				  and configuration files to check that they
#				  were not tampered/modified.

export PATH=/usr/bin:/usr/sbin:$PATH

# Initialize variables AIXPERT_FIFO, LOG, REPORT, SCPTDIR and UNDOXML
. /etc/security/aixpert/bin/initialize_variables

TMP=/etc/security/aixpert/tmp/virusdetsw
PID=$$

# Log output and errors to /etc/security/aixpert/log/aixpert.log
exec 1>>$LOG
exec 2>&1

if [ $# -ne 0 ]
then
	dspmsg -s 33 aixpert.cat 1 "Usage: virusdetsw\n"
	exit 1
fi

set -x
date
echo $0

report=`echo $AIXPERT_CHECK_REPORT`
if [ "$report" != "1" ]
then
	/usr/sbin/trustchk -n all
	rc=$?
	if [ $rc -ne 0 ]
	then
		dspmsg -s 33 aixpert.cat 2 "virusdetsw.sh: trustchk command\
 failed with exit code %d\n" $rc
		exit 1
	fi

	empty=`grep "^<AIXPertUndo>" $UNDOXML`
	if [ "$empty" = "" ]
	then
		echo "\n<AIXPertUndo>\n</AIXPertUndo>" >> $UNDOXML
	fi

	# Get the rulename and put it in undo rule
	name=`echo $AIXPERT_NAME`
	# Get the rule description & pass it to undo rule
	desc=`echo $AIXPERT_DESC`

	# Add an undo XML rule to the file $UNDOXML
	awk -v rulehalf1="\t<AIXPertEntry name=\"$name\">\n\
\t\t<AIXPertRuleType type=\"Undo\"/>\n\
\t\t<AIXPertDescription>Undo action for \"$desc\"</AIXPertDescription>\n\
\t\t<AIXPertPrereqList/>\n"\
 -v rulehalf2="\t\t<AIXPertCommand>/etc/security/aixpert/bin/execmds\
</AIXPertCommand>\n\t\t<AIXPertArgs>\"/usr/sbin/trustchk -n all\"</AIXPertArgs>\n\
\t\t<AIXPertGroup>SOX-COBIT Best Practices Security</AIXPertGroup>\n\
\t</AIXPertEntry>" '{if(match($0,"^[\t ]*</AIXPertUndo>")==0) print $0;\
 else print rulehalf1 rulehalf2 "\n" $0}' $UNDOXML >$TMP$PID
	mv $TMP$PID $UNDOXML

else
	/usr/sbin/trustchk -n all
	rc=$?
	if [ $rc -ne 0 ]
	then
		dspmsg -s 33 aixpert.cat 3 "virusdetsw.sh: trustchk command\
 found mismatches for some files with respect to the TSS database\n" >>$REPORT
		dspmsg -s 33 aixpert.cat 3 "virusdetsw.sh: trustchk command\
 found mismatches for some files with respect to the TSS database\n" >>$AIXPERT_FIFO
		exit 1
	fi
fi

exit 0

