#!/usr/bin/ksh
# IBM_PROLOG_BEGIN_TAG 
# This is an automatically generated prolog. 
#  
# bos61J src/bos/usr/lib/security/aixpert/scripts/rmdotfrmpathnroot.sh 1.3.1.2 
#  
# Licensed Materials - Property of IBM 
#  
# Restricted Materials of IBM 
#  
# COPYRIGHT International Business Machines Corp. 2006,2010 
# All Rights Reserved 
#  
# US Government Users Restricted Rights - Use, duplication or 
# disclosure restricted by GSA ADP Schedule Contract with IBM Corp. 
#  
# IBM_PROLOG_END_TAG 
# @(#)11	1.3.1.2  src/bos/usr/lib/security/aixpert/scripts/rmdotfrmpathnroot.sh, aixpert, bos61J 5/7/10 14:04:25
#	COMPONENT_NAME		: (AIXPERT) rmdotfrmpathnroot.sh
#	FUNCTIONS		: None
#	ORIGINS			: 27
#
#	Command Line Arguments	: None
#
#	OUTPUT			: None
#
#	Description		: This script scans files .profile, .kshrc, .cshrc
#				and .login in user's home directory and removes
#				dots, if any in PATH environment variable.
#				There is no undo rule for this script.
#				This script should be run with superuser privileges.

export PATH=/usr/bin:/usr/sbin:$PATH

# Initialize variables LOG and REPORT
. /etc/security/aixpert/bin/initialize_variables

TMP=/etc/security/aixpert/tmp/rmdotfrmpathnroot
PID=$$

# Determine whether "." exists in PATH env variable of the specified file
# PATH env variable can be of type
# PATH=".:/home/userx:/home/me/..:/usr/sbin/:.:/usr/bin:."
# PATH= .:/home/guest:/usr/bin
# set PATH=/usr/bin:$PATH
dotexists()
{
awk -F ";" '{
	for(i=1;i<=NF;i++) {
		if(match($i,"^[\t ]*(set)*[\t ]*PATH[\t ]*=") != 0){
			if( (match($i,"[\t ]*PATH[\t ]*=\\.:") != 0) ||\
 (match($i,"[\t ]*PATH[\t ]*=\"\\.:") != 0) || (match($i,":\\.$") != 0) ||\
 (match($i,":\\.\"$") != 0) || (match($i,":\\.:") != 0) )
				exit 1
		}
	}
}' $1
}

# Remove "." from the PATH environment variable, for the specified file
removedot()
{
awk  '	{
	if(match($0,"^[\t ]*(set)*[\t ]*PATH[\t ]*=") != 0){
		gsub("PATH[\t ]*=[\t ]*\\.:","PATH=");
		gsub("PATH[\t ]*=[\t ]*\"\\.:","PATH=");
		gsub(":\\.:",":");
		gsub(":\\.\"$","");
		gsub(":\\.$","");
		print $0;
	}
	else {
		print $0;
	}
}' $1 >$TMP$PID
/usr/bin/cp $TMP$PID $1
/usr/bin/rm -f $TMP$PID
}

# Log output and errors to /etc/security/aixpert/log/aixpert.log
exec 1>>$LOG
exec 2>&1

if [ $# -ne 0 ]
then
	dspmsg -s 22 aixpert.cat 1 "Usage: rmdotfrmpathnroot\n"
	exit 1
fi

# echo all the commands and the current time and date to the AIXpert log
set -x
date
echo $0

# Check whether AIXPERT_CHECK_REPORT environment variable is set or not.
report=`echo $AIXPERT_CHECK_REPORT`

# Counter to determine the number of failures in Dynamic Security Check
counter=0

list=".profile .kshrc .cshrc .login"
dispuid|while read x
do
	# Ignore LDAP/NIS user entries
	echo $x | grep ":" >/dev/null 2>&1
	if [ $? -eq 0 ]
	then
		continue;
	fi

	if [ $x != "root" ]
	then
		home=`lsuser -a home $x|awk -F "=" '{print $2}'`
		for i in $list
		do
			y=0
			if [ -e "$home/$i" ]
			then
				dotexists "$home/$i"
				y=$?

				if [ $y -eq 1 ]
				then
					# Dynamic Security Check
					if [ "$report" = "1" ]
					then
						counter=`expr $counter + 1`
						dspmsg -s 22 aixpert.cat 2\
 "rmdotfrmpathnroot.sh: A dot exists in PATH environment variable, in %s\
 file of user %s\n" $i $x >>$REPORT
					else
						removedot "$home/$i"
					fi
				fi
			fi
		done
	fi
done

# Exit for Dynamic Security Check
if [ "$report" = "1" ]
then
	if [ $counter -ne 0 ]
	then
		exit 1
	else
		exit 0
	fi
fi

exit 0
