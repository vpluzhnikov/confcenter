#!/usr/bin/ksh
# IBM_PROLOG_BEGIN_TAG 
# This is an automatically generated prolog. 
#  
# bos61H src/bos/usr/lib/security/aixpert/scripts/ipsecshunports.sh 1.5 
#  
# Licensed Materials - Property of IBM 
#  
# Restricted Materials of IBM 
#  
# COPYRIGHT International Business Machines Corp. 2006,2009 
# All Rights Reserved 
#  
# US Government Users Restricted Rights - Use, duplication or 
# disclosure restricted by GSA ADP Schedule Contract with IBM Corp. 
#  
# @(#)92	1.5  src/bos/usr/lib/security/aixpert/scripts/ipsecshunports.sh, aixpert, bos61H, 0921A_61H 5/4/09 15:03:10
# IBM_PROLOG_END_TAG 
#	COMPONENT_NAME		: (AIXPERT) ipsecshunports.sh
#	FUNCTIONS		: None
#	ORIGINS			: 27
#
#	Command Line Arguments	: This script expects one command line argument,
#				i.e.,rulename.
#				Syntax: ipsecshunports rulename
#
#	OUTPUT			: None
#
#	Description		: This script shuns all vunerable ports for 5 minutes.
#				It dynamically generates undo xml rule.
#				This script should be run with superuser privileges.

export PATH=/usr/bin:/usr/sbin:$PATH

# Initialize variables AIXPERT_FIFO, LOG, REPORT, SCPTDIR and UNDOXML
. /etc/security/aixpert/bin/initialize_variables

TMP=/etc/security/aixpert/tmp/ipsecshunports
PID=$$

# Log output and errors to /etc/security/aixpert/log/aixpert.log
exec 1>>$LOG
exec 2>&1

if [ $# -ne 1 ]
then
	dspmsg -s 13 aixpert.cat 1 "Usage: ipsecshunports rulename\n"
	exit 1
fi

# exit success for Dynamic check securiy
report=`echo $AIXPERT_CHECK_REPORT`
if [ "$report" = "1" ]
then
	exit 0
fi

# echo all the commands and the current time and date to the AIXpert log
set -x
date
echo $0

# Determine whether IPSec is enabled or not.
ipv4=`lsdev -Cc ipsec|grep ipsec_v4|awk '{print $2}'`
ipv6=`lsdev -Cc ipsec|grep ipsec_v6|awk '{print $2}'`

# Get the source ip(version 4) address of the host, sometimes this address
# might have more than one entry, when we have multiple interfaces
hostipv4=`ifconfig -a|grep "inet "|awk '{print $2}'|grep -v -w "127.0.0.1"`

# Get the source ip(version 6) address of the host
hostipv6=`ifconfig -a|grep "inet6 "|awk '{print $2}'|awk -F "/" '{print $1}'|\
awk -F "%" '{print $1}'|grep -v -w "::1"`

# Get the list of open ports in LISTEN mode
openports=`netstat -an|grep -i listen|awk '{if (match($4,/\*\./) != 0)\
 {gsub(/\*\./,"",$4); print $4}}'`

# A value of 0 indicates that Undo rule need not be created. This variable
# will be set later in the script if there is anything to be undone
undo=0

# List of vunerable tcp ports
vtcpports="11 13 19 25 43 63 67 68 69 79 87 110 113 194 443 511 514 520\
 540 546 547 555 559 593 666 777 901 902 903 1024"
# List of vunerable udp ports
vudpports="11 13 19 43 63 67 68 69 79 111 113 123 161 162 194 546 547 635 666"

# All these filter rules will be added before the existing rules in the filter rule table
if [ "$ipv4" = "Available" ]
then
	# Add filter rules to shun ports on all interfaces
	for i in ${hostipv4}
	do
		for j in $vtcpports
		do
			# Check whether port specified by $j is in listen mode
			echo $openports|grep -w $j

			if [ $? -ne 0 ]		# The port $j is not in listen mode
			then
				undo=1
				# Shun these particular ports for 5 minutes
				genfilt -v4 -n 2 -a S\
 -s 0.0.0.0 -m 0.0.0.0 -d $i -M 255.255.255.255 -c tcp\
 -O eq -P $j -w I -D "AIXpert:IPv4:ShunPort$i$j" -e 300
				if [ $? -ne 0 ]
				then
					dspmsg -s 13 aixpert.cat 2\
 "ipsecshunports.sh: genfilt failed to add filter for IPSec Version 4\n"
					exit 1
				fi
			fi
		done
		for j in $vudpports
		do
			# Check whether port specified by $j is in listen mode
			echo $openports|grep -w $j

			if [ $? -ne 0 ]		# The port $j is not in listen mode
			then
				undo=1
				# Shun these particular ports for 5 minutes
				genfilt -v4 -n 2 -a S\
 -s 0.0.0.0 -m 0.0.0.0 -d $i -M 255.255.255.255 -c udp\
 -O eq -P $j -w I -D "AIXpert:IPv4:ShunPort$i$j" -e 300
				if [ $? -ne 0 ]
				then
					dspmsg -s 13 aixpert.cat 2\
 "ipsecshunports.sh: genfilt failed to add filter for IPSec Version 4\n"
					exit 1
				fi
			fi
		done
	done

	# Activate the IPSec v4 filters added.
	mkfilt -v4 -u
	if [ $? -ne 0 ]
	then
		dspmsg -s 13 aixpert.cat 3 "ipsecshunports.sh:\
 mkfilt failed to activate filter rules for IPSec Version 4\n"
		exit 1
	fi
fi
if [ "$ipv6" = "Available" ]
then
	# Add filter rules to shun ports on all interfaces
	for i in ${hostipv6}
	do
		for j in $vtcpports
		do
			# Check whether port specified by $j is in listen mode
			echo $openports|grep -w $j

			if [ $? -ne 0 ]		# The port $j is not in listen mode
			then
				undo=1
				# Shun these particular ports for 5 minutes
				genfilt -v6 -n 1 -a S\
 -s 0:0:0:0:0:0:0:0 -m 0 -d $i -M 128 -c tcp -O eq -P $j\
 -w I -D "AIXpert:IPv6:ShunPort$i$j" -e 300
				if [ $? -ne 0 ]
				then
					dspmsg -s 13 aixpert.cat 4\
 "ipsecshunports.sh: genfilt failed to add filter for IPSec Version 6\n"
					exit 1
				fi
			fi
		done
		for j in $vudpports
		do
			# Check whether port specified by $j is in listen mode
			echo $openports|grep -w $j

			if [ $? -ne 0 ]		# The port $j is not in listen mode
			then
				undo=1
				# Shun these particular ports for 5 minutes
				genfilt -v6 -n 1 -a S\
 -s 0:0:0:0:0:0:0:0 -m 0 -d $i -M 128 -c udp -O eq -P $j\
 -w I -D "AIXpert:IPv6:ShunPort$i$j" -e 300
				if [ $? -ne 0 ]
				then
					dspmsg -s 13 aixpert.cat 4\
 "ipsecshunports.sh: genfilt failed to add filter for IPSec Version 6"
					exit 1
				fi
			fi
		done
	done

	# Activate the IPSec v6 filters added.
	mkfilt -v6 -u
	if [ $? -ne 0 ]
	then
		dspmsg -s 13 aixpert.cat 5 "ipsecshunports.sh:\
 mkfilt failed to activate filter rules for IPSec Version 6\n"
		exit 1
	fi
fi

if [ $undo -eq 1 ]
then
	# Check if UNDOXML file has <AIXPertUndo> tag or not
	empty=`grep "^<AIXPertUndo>" $UNDOXML`
	if [ "$empty" = "" ]
	then
		echo "\n<AIXPertUndo>\n</AIXPertUndo>" >> $UNDOXML
	fi

	# Get the rulename and put it in undo rule
	name=`echo $AIXPERT_NAME`
	# Get the rule description & pass it to undo rule
	desc=`echo $AIXPERT_DESC`

	# Add an undo XML rule to the file $UNDOXML
	awk -v rulehalf1="\t<AIXPertEntry name=\"$name\">\n\
\t\t<AIXPertRuleType type=\"Undo\"/>\n\
\t\t<AIXPertDescription>Undo action for \"$desc\"</AIXPertDescription>\n\
\t\t<AIXPertPrereqList/>\n"\
 -v rulehalf2="\t\t<AIXPertCommand>/etc/security/aixpert/bin/ipsecundo\
</AIXPertCommand>\n\t\t<AIXPertArgs>ShunPort</AIXPertArgs>\n\
\t\t<AIXPertGroup>IPSec Filter Rules</AIXPertGroup>\n\
\t</AIXPertEntry>" '{if(match($0,"^[\t ]*</AIXPertUndo>")==0) print $0;\
 else print rulehalf1 rulehalf2 "\n" $0}' $UNDOXML >>$TMP$PID
	mv $TMP$PID $UNDOXML
fi

exit 0
