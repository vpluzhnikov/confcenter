#!/usr/bin/ksh
# IBM_PROLOG_BEGIN_TAG 
# This is an automatically generated prolog. 
#  
# bos610 src/bos/usr/lib/security/aixpert/scripts/cronaudit.sh 1.1 
#  
# Licensed Materials - Property of IBM 
#  
# Restricted Materials of IBM 
#  
# COPYRIGHT International Business Machines Corp. 2006 
# All Rights Reserved 
#  
# US Government Users Restricted Rights - Use, duplication or 
# disclosure restricted by GSA ADP Schedule Contract with IBM Corp. 
#  
# @(#)85	1.1  src/bos/usr/lib/security/aixpert/scripts/cronaudit.sh, aixpert, bos610 3/15/06 08:09:05
# IBM_PROLOG_END_TAG 
#	COMPONENT_NAME		: (AIXPERT) cronaudit.sh
#	FUNCTIONS		: None
#	ORIGINS			: 27
#
#	Command Line Arguments	: None
#
#	OUTPUT			: None
#
#	Description		: This script will be run as a root cronjob.
#
#	This script performs Audit Trail Copy Actions, if the following
#	equation is true:
#	Audit Freespace Equation:
#
#	if((sizeof /audit/trail) > (sizeof /audit/trailOneLevelBack))
#	then
#	AuditAdjust = (sizeof /audit/trail) - (sizeof /audit/trailOneLevelBack)
#	else
#	AuditAdjust = 0
#
#	if((total /audit freespace) - AuditAdjust) < (10% of total /audit space)
#	then perform Audit trail copy actions.
#	Audit Trail Copy actions:
#
#	1)Audit off
#	2)Move /audit/trail to /audit/trailOneLevelBack
#	3)Audit on
#
#	This script should be run with superuser privileges.

LOG=/etc/security/aixpert/log/aixpert.log

# Log output and errors to /etc/security/aixpert/log/aixpert.log
exec 1>>$LOG
exec 2>&1

if [ $# != 0 ]
then
        dspmsg -s 7 aixpert.cat 1 "Usage : cronaudit\n"
        exit 1
fi

# echo all the commands and the current time and date to the AIXpert log
set -x
date
echo $0

# Determine the size of /audit/trail file
trailsize=0

if [ -f /audit/trail ]
then
	trailsize=`ls -l /audit/trail | awk '{print $5}'`
fi

# Determine the size of /audit/trailOneLevelBack file
trailOneLevelBacksize=0

if [ -f /audit/trailOneLevelBack ]
then
	trailOneLevelBacksize=`ls -l /audit/trailOneLevelBack|awk '{print $5}'`
fi

# Determine the AuditAdjust
if [ $trailsize -gt $trailOneLevelBacksize ]
then
	auditadjust=`expr $trailsize - $trailOneLevelBacksize`
else
	auditadjust=0
fi

# Determine the total space in /audit filesystem
totalspace=`df | grep "/audit" | awk '{print $2}END{if(NR==0)exit 1}'`

if [ $? -ne 0 ]
then
	dspmsg -s 7 aixpert.cat 2 "cronaudit: Filesystem /audit is not\
 available or is not mounted\n"
	exit 1
fi

# Determine the freespace in /audit filesystem
freespace=`df | grep "/audit" | awk '{print $3}END{if(NR==0)exit 1}'`

if [ $? -eq 0 ]
then
	freespace=`expr \( $freespace \* 512 \) - $auditadjust` 
	cutoff=`expr \( $totalspace \* 512 / 10 \)`
	if [ $freespace -lt $cutoff ]
	then
		audit off
		mv /audit/trail /audit/trailOneLevelBack
		audit on
	fi
	exit 0
else
	dspmsg -s 7 aixpert.cat 2 "cronaudit: Filesystem /audit is not\
 available or is not mounted\n"
	exit 1
fi
