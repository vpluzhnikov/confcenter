# IBM_PROLOG_BEGIN_TAG         
# This is an automatically generated prolog.  
#                            
# $Source: aix71B bos/usr/lib/security/ice/scripts/nfsaccess.sh 1$                         
#                                                           
# COPYRIGHT International Business Machines Corp. 2010,2010              
#                                                                      
# Pvalue: p2 
#Licensed Materials - Property of IBM
#
#Restricted Materials of IBM
#
#US Government Users Restricted Rights - Use, duplication or
#disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
#
# Origin: 27
#
# sccsid: $Header: @(#) AIX71B_area/1 bos/usr/lib/security/ice/scripts/nfsaccess.sh, libice, aix71B, 1028A_71B 2010-06-24T16:57:24-05:00$
#
# IBM_PROLOG_END_TAG
#!/usr/bin/ksh

#nfs access
#GEN005820   	make sure fs is not exported to enable anonymous access
#GEN005840	 	restrict nfs fs access to local hosts	

INSTALLDIR=/etc/security/ice/scripts
. $INSTALLDIR/iceInit

PREREQ_LIST="bos.rte.security,bos.rte.date,bos.rte.ILS"

checkPrereq

# Check if the system has exported file system
if [ `exportfs | grep -c "nothing exported"` -gt 0 ]
then
	print "exportfs: nothing exported." >> log_msg 2>&1
	ice_status=0
	Script_Output
	exit 0
fi

EXPORTFILE=/etc/exports

###########
# Checking
###########
if [[ cflag -eq 1 ]];
then
	#GEN005820
	while read line
	do 
		if [ `echo $line | grep -c "^#"` -gt 0 ]
		then
			continue
		fi

		fs=`echo $line | cut -d " " -f1`

		if [ `echo $line | cut -d " " -f2 | egrep -c 'anon=-1| anon= -1| anon = -1'` -gt 0 ]
		then
			if [ "$STATUS_ARG" = "false" ]
			then
				cur_val=1
				print "Exported file system $fs has anon value of -1 to disable anonymous access." >> log_msg 2>&1
				ice_status=2
			fi
		else
			if [ "$STATUS_ARG" = "true" ]
			then
				print "Exported file system $fs does not set anon value to -1 to disable anonymous access." >> log_msg 2>&1
				ice_status=2
			fi
		fi
	done < $EXPORTFILE 

	#GEN005840
	while read line
	do
		if [ `echo $line | grep -c "^#"` -gt 0 ]
		then
			continue
		fi

		fs=`echo $line | cut -d " " -f1`

		if [ `echo $line | cut -d " " -f2 | egrep -c 'rw|ro'` -gt 0 ]
		then 
			if [ "$STATUS_ARG" = "false" ]
			then
				cur_val=1
				print "Exported file system $fs is exported as rw or ro." >> log_msg 2>&1
				ice_status=2
			fi
		else
			if [ "$STATUS_ARG" = "true" ]
			then
				print "Exported file system $fs does not does not exported as rw or ro." >> log_msg 2>&1
				ice_status=2
			fi
		fi
	done < $EXPORTFILE
	Script_Output
	exit 0
fi
####################
# Preview/Enforcing
####################
cur_val=
print "This rule does not support -e option." >> log_msg 2>&1
Script_Output
exit 0

