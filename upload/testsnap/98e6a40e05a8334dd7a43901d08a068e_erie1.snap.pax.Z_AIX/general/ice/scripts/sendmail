# IBM_PROLOG_BEGIN_TAG         
# This is an automatically generated prolog.  
#                            
# $Source: aix710 bos/usr/lib/security/ice/scripts/sendmail.sh 1$                         
#                                                           
# COPYRIGHT International Business Machines Corp. 2010,2010              
#                                                                      
# Pvalue: p2 
#Licensed Materials - Property of IBM
#
#Restricted Materials of IBM
#
#US Government Users Restricted Rights - Use, duplication or
#disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
#
# Origin: 27
#
# sccsid: $Header: @(#) AIX710_area/1 bos/usr/lib/security/ice/scripts/sendmail.sh, libice, aix710, 1020A_710 2010-05-12T16:23:37-05:00$
#
# IBM_PROLOG_END_TAG
#!/usr/bin/ksh
#       COMPONENT_NAME: (ICE) sendmail
#       FUNCTIONS:      None
#       ORIGINS:        27
#
#       Syntax:
#               sendmail -{c|e|p}[v] rulename toggle
#       Parameters:
#               -c      - Check mode
#               -e      - Enforce mode
#               -p      - Preview mode
#               -v      - verbose mode (unimplemented)
#               lname   - rule_name
#               toggle  - Boolean
#                         false => Disable compliance
#                         true  => Enable compliance

#       OUTPUT:
#               0       - success
#               1       - check/enforce failure
#
#       Description:
#		GEN004540: CAT II
#               This script enables/disbles sendmail features
#		This script should be run with superuser privileges.
#		GEN004580: CAT I
#				Ensure .forward file does not exist or this is 
#				a finding.

INSTALLDIR=/etc/security/ice/scripts
. $INSTALLDIR/iceInit

PREREQ_LIST="bos.rte.security,bos.rte.date,bos.rte.ILS"

checkPrereq

# Check if sendmail is running
if [ `ps -e | grep -v grep | grep -c sendmail` -eq 0 ]
then
        print "sendmail is not running." >> log_msg 2>&1
        ice_status=1
        Script_Output
        exit 0
fi

# Check if help entry is in sendmail configuration
if [ `grep -c '^O HelpFile=/etc/mail/helpfile' /etc/mail/sendmail.cf` -eq 0 ]
then
        print "sendmail helpfile entry not found in /etc/mail/sendmail.cf" >> log_msg 2>&1
        ice_status=1
        Script_Output
        exit 0
fi

find /home/* -name .forward -print > $TMPF1
###########
# Checking
###########
if [[ cflag -eq 1 ]];
then
	if [ -s /etc/mail/helpfile ]
	then
                cur_val=1
                # Enable case
                if [ "$STATUS_ARG" = "true" ]
                then
                        print "sendmail help is enabled" >> log_msg 2>&1
                        ice_status=2
                fi
	else
                cur_val=0
                # Default case
                if [ "$STATUS_ARG" = "false" ]
                then
                        print "sendmail help is disabled" >> log_msg 2>&1
                        ice_status=2
                fi
	fi

	if [[ -s $TMPF1 && `cat $TMPF1 | egrep -c ".forward"` -gt 0 ]]
	then
		if [ "$STATUS_ARG" = "true" ]
		then
			cur_val=1
			print ".forward file exists." >> log_msg 2>&1
			ice_status=2
		fi
	else
		if [ "$STATUS_ARG" = "false" ]
		then
			cur_val=0
			print ".forward file does not exist." >> log_msg 2>&1
			ice_status=2
		fi
	fi

	rm $TMPF1
	Script_Output
	exit 0
fi

####################
# Preview/Enforcing
####################
cur_val=
if [ ! -s /etc/mail/helpfile ]
then
        if [ "$STATUS_ARG" = "false" ]
        then
                $ECHOPREFIX touch /etc/mail/helpfile >> log_msg 2>&1
				echo "#" >> /etc/mail/helpfile
                if [ $? -ne 0 ]
                then
                        ice_status=1
                        print "Error in enabling sendmail help." >> log_msg 2>&1
                fi
        fi
else
        if [ "$STATUS_ARG" = "true" ]
        then
                $ECHOPREFIX rm /etc/mail/helpfile >> log_msg 2>&1
                if [ $? -ne 0 ]
                then
                        ice_status=1
                        print "Error in disabling sendmail help." >> log_msg 2>&1
                fi
        fi
fi

if [ "$STATUS_ARG" = "true" ]
then
	while read line
	do
		$ECHOPREFIX rm $line >> log_msg 2>&1
	done < $TMPF1
else
	if [ ! -e /home/guest/.forward ]
	then
		touch /home/guest/.forward
	fi
fi

rm $TMPF1
Script_Output
exit 0
