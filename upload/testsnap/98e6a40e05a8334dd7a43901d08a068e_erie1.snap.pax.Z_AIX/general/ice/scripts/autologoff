#!/usr/bin/ksh
# IBM_PROLOG_BEGIN_TAG         
# This is an automatically generated prolog.  
#                            
# $Source: aix710 bos/usr/lib/security/ice/scripts/autologoff.sh 1$                         
#                                                           
# COPYRIGHT International Business Machines Corp. 2010,2010              
#                                                                      
# Pvalue: p2 
#Licensed Materials - Property of IBM
#
#Restricted Materials of IBM
#
#US Government Users Restricted Rights - Use, duplication or
#disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
#
# Origin: 27
#
# sccsid: $Header: @(#) AIX710_area/1 bos/usr/lib/security/ice/scripts/autologoff.sh, libice, aix710, 1010A_710 2010-03-02T17:22:38-06:00$
#
# IBM_PROLOG_END_TAG
#       COMPONENT_NAME: (ICE) autologoff.sh
#       FUNCTIONS:      None
#       ORIGINS:        27
#
#       Syntax:
#               autologoff -{c|e|p}[v] lname time 
#       Parameters:
#               -c      - Check mode
#               -e      - Enforce mode
#               -p      - Preview mode
#               -v      - verbose mode (unimplemented)
#		lname	- rule_name
#		time	- auto logoff time in minutes 
#       OUTPUT:
#               0       - success
#               1       - check/enforce failure
#
#       Description:
#		This script adds/removes the auto logoff entry to
#		/etc/profle file. This script should be run
#		with superuser privileges.

export PATH=/usr/bin:/usr/sbin:$PATH
exec 2>&1

###
#Print Usage
###
Usage() {
	ice_status=1
        print "usage: \n
   autologoff -{c|e|p}[v] lname time\n" >> log_msg 2>&1
}

###
#Output from Script to the Native Library
###
Script_Output() {
        print -n "$cur_val%$ice_status%"
        cat log_msg
        print
}

###
#Process arguments
###

#Check mode
cflag=0
#Enforce mode
eflag=0
#Preview mode
pflag=0
#Verbose mode
vflag=0

###
#Initialize the Script Output variables
###
cur_val=
ice_status=0
print -n > log_msg 2>&1

while getopts :cevp OPT
do
        case $OPT in
                c)      cflag=1;;
                e)      eflag=1;;
                v)      vflag=1;;
                p)      pflag=1;;
                ?|:)    Usage
			Script_Output
                        exit 1;;
        esac
done
shift $(($OPTIND -1))

#Enable Verbose
if [[ vflag -eq 1 ]];
then
        set -x
fi

#Need 2 arguments
if [ $# -lt 2 ]  
then
        Usage
	Script_Output
        exit 1
fi


RULENAME=$1
VALUE=$2

# Convert to seconds
let "TIME = $VALUE * 60"

# -c, -e and -p mutually exclusive
((chkflg=cflag+eflag+pflag))
if [[ chkflg -ne 1 ]];
then
        Usage
	Script_Output
        exit 1
fi

# Preview mode set-up
if [[ pflag -eq 1 ]];
then
        ECHOPREFIX="echo"
else
        ECHOPREFIX=""
fi


PREREQ=/etc/security/ice/scripts/chkprereq
PREREQ_LIST="bos.rte.date,bos.rte.commands,bos.rte.shell,bos.rte.ILS"

$ECHOPREFIX $PREREQ $PREREQ_LIST

if [ $? -ne 0 ]
then
        print "prereq missing... \n"
	print "Prereqs needed: " $PREREQ_LIST >> log_msg 2>&1
	ice_status=1
        Script_Output
        exit 0
fi

exists=false

# Add the Timeout entry
add_timeout()
{
	# Only add the Newline if TIMEOUT entry did not exist
	if [ "$exists" == "false" ]
	then
		awk 'END {print "\n"}' /etc/profile >> /etc/profile
	fi

        sed -e '$s/$/&\TMOUT='"$TIME"' ; TIMEOUT='"$TIME"' ; export TMOUT TIMEOUT/' /etc/profile > /etc/profile_new
	mv /etc/profile_new /etc/profile
	chmod 750 /etc/profile
}

#Remove the Timeout entry
remove_timeout()
{
	egrep -v TMOUT= /etc/profile > /etc/profile_new
	mv /etc/profile_new /etc/profile
	chmod 750 /etc/profile
}

#checking
if [[ cflag -eq 1 ]];
then
	if [ -e /etc/profile ]
        then
		grep -v '^[[:space:]]*#' /etc/profile | grep TMOUT  > /dev/null 2>&1	
		if [ $? -ne 0 ]
		then
			# Default case
			if [ "$TIME" = "0" ]
			then
				cur_val=$VALUE
				ice_status=0
				Script_Output
			else
				cur_val=$VALUE
				ice_status=2
				print "autologoff:/etc/profile file does not have automatic timeout logoff entry in it" >> log_msg 2>&1
				Script_Output
			fi
		else
			if [ "$TIME" = "0" ]
			then
				cur_val=$VALUE
				ice_status=2
				print "autologoff:/etc/profile file contains automatic timeout logoff entry in it" >> log_msg 2>&1
				Script_Output
			else
				cur_val=$VALUE
				ice_status=0
				Script_Output
			fi
		fi
	# File does not exist
	else
		# Default case
		if [ "$TIME" = "0" ]
		then
			cur_val=$VALUE
			ice_status=0
			Script_Output
		else
			cur_val=$VALUE
			ice_status=2
			print "autologoff: /etc/profile file does not exist" >> log_msg 2>&1
			Script_Output
		fi
	fi
exit 0
fi


###
#Preview/Enforcing
###

if [ -e /etc/profile ]
then
	grep -v '^[[:space:]]*#' /etc/profile | grep TMOUT  > /dev/null 2>&1
	if [ $? -ne 0 ]
	then
		if [ "$TIME" != "0" ]
		then
			add_timeout
			ice_status=0
		fi
	# Timeout exists, Remove for default and update for non default
	else
		remove_timeout
		if [ "$TIME" != "0" ]
		then
			exists=true
			add_timeout
			ice_status=0
		fi
	fi
else
	if [ "$TIME" != "0" ]
	then
		add_timeout
                ice_status=0
	fi
fi

Script_Output
exit 0
